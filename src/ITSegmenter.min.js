var outputRects={};outputRects={};function textSegment(t,r,e,a,n,i,o,s,h,u){void 0===r&&(r=100),void 0===e&&(e=15),void 0===a&&(a=5),void 0===n&&(sharpness=10),void 0===i&&(sharpness=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===h&&(h=1);var l,c,d=Date.now(),f=t,v=new Image;if(v.src=f,void 0===u)var g=document.createElement("CANVAS");else g=document.getElementById(u);0==h&&void 0===u&&document.body.appendChild(g);var p=g.getContext("2d");v.onerror=function(){alert("Image Error")},v.onload=function(){if(l=v.width,c=v.height,g.width=l,g.height=c,c*l>16e4)var t=Math.round(16e4/c/l*100)/100;else t=1;var u=Math.round(1/t*100)/100;p.drawImage(v,0,0,l,c),canvasf=scaleCanvas(t,g);var f=canvasf.getContext("2d");0!=n&&sharpen(f,l*t,c*t,n,i);var m=DBSCAN(findCorners(f,l*t,c*t,r),e,a);if(Object.keys(m).map(function(t,r){var e=m[t].map(function(t){return[t[0]*u,t[1]*u]});m[t]=e}),outputRects=textRect(p,m),1==o&&1==h){var C=document.createElement("img");C.setAttribute("src",g.toDataURL("image/png")),document.body.appendChild(C)}return 1==s&&cropRects(outputRects,v),console.log(Date.now()-d),outputRects}}function findCorners(t,r,e,a){var n=[];Fast.THRESHOLD=a;for(var i=t.getImageData(0,0,r,e),o=TImage.grayscale(i.data,r,e),s=Fast.findCorners(o,r,e),h=0;h<s.length;h+=2)n.push([s[h],s[h+1]]);return n}function textRect(t,r){var e={},a=[];C=0;for(var n in r){var i=Math.max.apply(null,r[n].map(function(t){return t[0]})),o=Math.min.apply(null,r[n].map(function(t){return t[0]})),s=Math.max.apply(null,r[n].map(function(t){return t[1]})),h=Math.min.apply(null,r[n].map(function(t){return t[1]}));"noise"!=n&&(drawPoly(t,[Math.max(0,o-5),Math.max(0,h-5)],[Math.max(0,o-5),Math.max(0,s+5)],[Math.max(0,i+5),Math.max(0,s+5)],[Math.max(0,i+5),Math.max(0,h-5)]),C+=1,e[C]=[Math.max(0,o-5),Math.max(0,i+5),Math.max(0,h-5),Math.max(0,s+5)],a.push([Math.round(o+(i-o)/2),Math.round(h+(s-h)/2),,C]))}return e}function drawPoly(t,r,e,a,n){t.beginPath(),t.moveTo(r[0],r[1]),t.lineTo(e[0],e[1]),t.lineTo(a[0],a[1]),t.lineTo(n[0],n[1]),t.closePath(),t.stroke()}function cropRects(t,r){for(var e=document.createElement("canvas"),a=e.getContext("2d"),n=1;n<=Object.keys(t).length;n++){var i=t[n][1]-t[n][0],o=t[n][3]-t[n][2];e.width=i,e.height=o,a.drawImage(r,t[n][0],t[n][2],i,o,0,0,i,o);var s=document.createElement("img");s.setAttribute("src",e.toDataURL("image/png")),document.body.appendChild(s)}}function scaleCanvas(t,r){var e=r.width,a=r.height,n=document.createElement("CANVAS");return n.width=r.width*t,n.height=r.height*t,n.getContext("2d").drawImage(r,0,0,e,a,0,0,t*e,t*a),n}function sharpen(t,r,e,a,n){for(var i=t.createImageData(r,e),o=t.getImageData(0,0,r,e).data,s=gaussBlur(o,r,e,a),h=new Uint8ClampedArray(r*e*4),u=0;u<h.length;u++)h[u]=o[u]-s[u];for(u=0;u<i.data.length;u++)i.data[u]=o[u]+n*h[u];t.putImageData(i,0,0)}function gaussBlur(t,r,e,a){var n=boxesForGauss(a/4,3);return boxBlur(boxBlur(boxBlur(t,r,e,n[0]),r,e,n[1]),r,e,n[2])}function boxesForGauss(t,r){var e=Math.sqrt(12*t*t/r+1),a=Math.floor(e);a%2==0&&a--;for(var n=a+2,i=(12*t*t-r*a*a-4*r*a-3*r)/(-4*a-4),o=Math.round(i),s=[],h=0;h<r;h++)s.push(h<o?a:n);return s}function boxBlur(t,r,e,a){return boxBlurH(boxBlurV(t,r,e,a),r,e,a)}function boxBlurV(t,r,e,a){for(var n,i,o,s,h,u,l,c,d,f=Math.floor(a/2),v=new Float32Array(r*e*4),g=0;g<r;g++)for(var p=0;p<e;p++){n=p,i=g,o=4*(p*r+g),s=0,h=0,u=0,l=0;for(var m=0;m<a;m++)s+=t[c=4*(Math.min(e-1,Math.max(0,n+m-f))*r+i)],h+=t[c+1],u+=t[c+2],l+=t[c+3];d=1/a,v[o]=s*d,v[o+1]=h*d,v[o+2]=u*d,v[o+3]=l*d}return v}function boxBlurH(t,r,e,a){a=a;for(var n,i,o,s,h,u,l,c,d,f=Math.floor(a/2),v=new Float32Array(r*e*4),g=0;g<e;g++)for(var p=0;p<r;p++){n=g,i=p,o=4*(g*r+p),s=0,h=0,u=0,l=0;for(var m=0;m<a;m++)s+=t[c=4*(n*r+Math.min(r-1,Math.max(0,i+m-f)))],h+=t[c+1],u+=t[c+2],l+=t[c+3];d=1/a,v[o]=s*d,v[o+1]=h*d,v[o+2]=u*d,v[o+3]=l*d}return v}function DBSCAN(t,r,e){for(var a=new kdTree(t),n={},i=0,o=0;o<t.length;o++)if(void 0==n[t[o]])if(N=RangeQuery(t,t[o],r,a),N.length<e)n[t[o]]="noise";else{i+=1,n[t[o]]=i;for(var s=N,h=0;h<s.length;h++)"noise"==n[s[h]]&&(n[s[h]]=i),void 0==n[s[h]]&&(n[s[h]]=i,N=RangeQuery(t,s[h],r,a),N.length>=e&&s.push.apply(s,N))}var u={};for(var l in n)n[l]in u||(u[n[l]]=[]),u[n[l]].push(l.split(","));return u}function RangeQuery(t,r,e,a){return a.rangeSearch(r[0],r[1],e)}function distFunc(t,r){return D=Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2)),D}function kdTree(t){var r=[];!function t(e,a){var n=a%2;var i=e.length;var o=Math.floor((e.length-1)/2);var s=e.length-1;{if(!(o>=0))return;var h=quickSelect(e,0,s,o,n)}var u=new function(t,r,e,a){this.position=t,this.leftChild=r,this.rightChild=e,this.depth=a};u.position=h;i>1&&o>=0&&(u.leftChild=t(e.slice(0,o),a+1),u.rightChild=t(e.slice(o+1,s+1),a+1));u.depth=a;r.push(u);return u}(t,0),this.nodes=r,this.rootNode=r[r.length-1],this.rangeSearch=function(t,r,e){var a=[];return rangeSearch(t,r,e,this.rootNode,a),a}}function quickSelect(t,r,e,a,n){return r==e?t[r]:(pivotIndex=Math.floor(Math.random()*(e-r+1)+r),pivotIndex=partition(t,r,e,pivotIndex,n),a==pivotIndex?t[a]:a<pivotIndex?quickSelect(t,r,pivotIndex-1,a,n):quickSelect(t,pivotIndex+1,e,a,n))}function partition(t,r,e,a,n){pivotVal=t[a][n],swap(t,a,e);for(var i=r,o=r;o<=e-1;o++)t[o][n]<pivotVal&&(swap(t,i,o),i++);return swap(t,e,i),i}function swap(t,r,e){var a=t[r];t[r]=t[e],t[e]=a}function rangeSearch(t,r,e,a,n){var i=e*e;return void 0==a.leftChild&&void 0==a.rightChild?void(squareDist(a.position,[t,r])<=i&&n.push(a.position)):intersects(t,r,a,e)?(squareDist(a.position,[t,r])<=i&&n.push(a.position),void 0!=a.leftChild&&rangeSearch(t,r,e,a.leftChild,n),void(void 0!=a.rightChild&&rangeSearch(t,r,e,a.rightChild,n))):void(void 0!=a.leftChild&&1==isLeft(t,r,a)?rangeSearch(t,r,e,a.leftChild,n):rangeSearch(t,r,e,a.rightChild,n))}function getDescendants(t,r){void 0!=t.leftChild&&(r.push(t.leftChild.position),getDescendants(t.leftChild,r)),void 0!=t.rightChild&&(r.push(t.rightChild.position),getDescendants(t.rightChild,r))}function intersects(t,r,e,a){var n=a*a,i=e.depth%2;return 0==i&&squareDist([t,r],[e.position[0],r])<=n||1==i&&squareDist([t,r],[t,e.position[1]])<=n}function squareDist(t,r){var e=t[0]-r[0],a=t[1]-r[1];return sD=e*e+a*a,sD}function isLeft(t,r,e){return 0==e.depth%2?t<=e.position[0]:r<=e.position[1]}Fast={},Fast.THRESHOLD=40,Fast.circles_={},Fast.findCorners=function(t,r,e,a){var n=this.getCircleOffsets_(r),i=new Int32Array(16),o=[];void 0===a&&(a=this.THRESHOLD);for(var s=3;s<e-3;s++)for(var h=3;h<r-3;h++){for(var u=s*r+h,l=t[u],c=0;c<16;c++)i[c]=t[u+n[c]];this.isCorner(l,i,a)&&(o.push(h,s),h+=3)}return o},Fast.isBrighter=function(t,r,e){return t-r>e},Fast.isCorner=function(t,r,e){if(this.isTriviallyExcluded(r,t,e))return!1;for(var a=0;a<16;a++){for(var n=!0,i=!0,o=0;o<9;o++){var s=r[a+o&15];if(!this.isBrighter(t,s,e)&&(i=!1,!1===n))break;if(!this.isDarker(t,s,e)&&(n=!1,!1===i))break}if(i||n)return!0}return!1},Fast.isDarker=function(t,r,e){return r-t>e},Fast.isTriviallyExcluded=function(t,r,e){var a=0,n=t[8],i=t[12],o=t[4],s=t[0];return this.isBrighter(s,r,e)&&a++,this.isBrighter(o,r,e)&&a++,this.isBrighter(n,r,e)&&a++,this.isBrighter(i,r,e)&&a++,a<3&&(a=0,this.isDarker(s,r,e)&&a++,this.isDarker(o,r,e)&&a++,this.isDarker(n,r,e)&&a++,this.isDarker(i,r,e)&&a++,a<3)},Fast.getCircleOffsets_=function(t){if(this.circles_[t])return this.circles_[t];var r=new Int32Array(16);return r[0]=-t-t-t,r[1]=r[0]+1,r[2]=r[1]+t+1,r[3]=r[2]+t+1,r[4]=r[3]+t,r[5]=r[4]+t,r[6]=r[5]+t-1,r[7]=r[6]+t-1,r[8]=r[7]-1,r[9]=r[8]-1,r[10]=r[9]-t-1,r[11]=r[10]-t-1,r[12]=r[11]-t,r[13]=r[12]-t,r[14]=r[13]-t+1,r[15]=r[14]-t+1,this.circles_[t]=r,r},TImage={},TImage.grayscale=function(t,r,e,a){for(var n=new Uint8ClampedArray(a?t.length:t.length>>2),i=0,o=0,s=0;s<e;s++)for(var h=0;h<r;h++){var u=.299*t[o]+.587*t[o+1]+.114*t[o+2];n[i++]=u,a&&(n[i++]=u,n[i++]=u,n[i++]=t[o+3]),o+=4}return n};