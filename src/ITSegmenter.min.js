var outputRects={};function textSegment(t,e,n,a,i,o,h,s,u,r){void 0===e&&(e=100),void 0===n&&(n=15),void 0===a&&(a=5),void 0===i&&(sharpness=10),void 0===o&&(sharpness=1),void 0===h&&(h=0),void 0===s&&(s=0),void 0===u&&(u=1);var l=Date.now(),c=t,d=new Image;if(d.src=c,void 0===r)var f=document.createElement("CANVAS");else f=document.getElementById(r);var g,p,v=document.createElement("CANVAS");0==u&&void 0===r&&document.body.appendChild(f);var m=f.getContext("2d"),C=v.getContext("2d");d.onerror=function(){alert("Image Error")},d.onload=function(){g=d.width,p=d.height,f.width=g,f.height=p,v.width=g,v.height=p,m.drawImage(d,0,0,g,p),C.drawImage(d,0,0,g,p),0!=i&&sharpen(C,g,p,i,o);var t=DBSCAN(findCorners(C,g,p,e),n,a);if(outputRects=textRect(m,t),1==h&&1==u){var r=document.createElement("img");r.setAttribute("src",f.toDataURL("image/png")),document.body.appendChild(r)}return 1==s&&cropRects(outputRects,d),console.log(Date.now()-l),outputRects}}function findCorners(t,r,e,n){var a=[];Fast.THRESHOLD=n;for(var i=t.getImageData(0,0,r,e),o=TImage.grayscale(i.data,r,e),h=Fast.findCorners(o,r,e),s=0;s<h.length;s+=2)a.push([h[s],h[s+1]]);return a}function textRect(t,r){var e={},n=[];for(var a in C=0,r){var i=Math.max.apply(null,r[a].map(function(t){return t[0]})),o=Math.min.apply(null,r[a].map(function(t){return t[0]})),h=Math.max.apply(null,r[a].map(function(t){return t[1]})),s=Math.min.apply(null,r[a].map(function(t){return t[1]}));"noise"!=a&&(drawPoly(t,[Math.max(0,o-5),Math.max(0,s-5)],[Math.max(0,o-5),Math.max(0,h+5)],[Math.max(0,i+5),Math.max(0,h+5)],[Math.max(0,i+5),Math.max(0,s-5)]),C+=1,e[C]=[Math.max(0,o-5),Math.max(0,i+5),Math.max(0,s-5),Math.max(0,h+5)],n.push([Math.round(o+(i-o)/2),Math.round(s+(h-s)/2),,C]))}return e}function drawPoly(t,r,e,n,a){t.beginPath(),t.moveTo(r[0],r[1]),t.lineTo(e[0],e[1]),t.lineTo(n[0],n[1]),t.lineTo(a[0],a[1]),t.closePath(),t.stroke()}function cropRects(t,r){for(var e=document.createElement("canvas"),n=e.getContext("2d"),a=1;a<=Object.keys(t).length;a++){var i=t[a][1]-t[a][0],o=t[a][3]-t[a][2];e.width=i,e.height=o,n.drawImage(r,t[a][0],t[a][2],i,o,0,0,i,o);var h=document.createElement("img");h.setAttribute("src",e.toDataURL("image/png")),document.body.appendChild(h)}}function scaleCanvas(t,r,e){var n=e.width,a=e.height;r.width=e.width*t,r.height=e.height*t,r.getContext("2d").drawImage(e,0,0,n,a,0,0,t*n,t*a)}function include(t){var r=document.getElementsByTagName("head")[0],e=document.createElement("script");e.type="text/javascript",e.src=t,r.appendChild(e)}function sharpen(t,r,e,n,a){for(var i=t.createImageData(r,e),o=t.getImageData(0,0,r,e).data,h=gaussBlur(o,r,e,n),s=new Uint8ClampedArray(r*e*4),u=0;u<s.length;u++)s[u]=o[u]-h[u];for(u=0;u<i.data.length;u++)i.data[u]=o[u]+a*s[u];t.putImageData(i,0,0)}function gaussBlur(t,r,e,n){var a=boxesForGauss(n/4,3);return boxBlur(boxBlur(boxBlur(t,r,e,a[0]),r,e,a[1]),r,e,a[2])}function boxesForGauss(t,r){var e=Math.sqrt(12*t*t/r+1),n=Math.floor(e);n%2==0&&n--;for(var a=n+2,i=(12*t*t-r*n*n-4*r*n-3*r)/(-4*n-4),o=Math.round(i),h=[],s=0;s<r;s++)h.push(s<o?n:a);return h}function boxBlur(t,r,e,n){return boxBlurH(boxBlurV(t,r,e,n),r,e,n)}function boxBlurV(t,r,e,n){for(var a,i,o,h,s,u,l,c,d,f=Math.floor(n/2),g=new Float32Array(r*e*4),p=0;p<r;p++)for(var v=0;v<e;v++){o=4*((a=v)*r+(i=p));for(var m=l=u=s=h=0;m<n;m++)h+=t[c=4*(Math.min(e-1,Math.max(0,a+m-f))*r+i)],s+=t[c+1],u+=t[c+2],l+=t[c+3];d=1/n,g[o]=h*d,g[o+1]=s*d,g[o+2]=u*d,g[o+3]=l*d}return g}function boxBlurH(t,r,e,n){n=n;for(var a,i,o,h,s,u,l,c,d,f=Math.floor(n/2),g=new Float32Array(r*e*4),p=0;p<e;p++)for(var v=0;v<r;v++){o=4*((a=p)*r+(i=v));for(var m=l=u=s=h=0;m<n;m++)h+=t[c=4*(a*r+Math.min(r-1,Math.max(0,i+m-f)))],s+=t[c+1],u+=t[c+2],l+=t[c+3];d=1/n,g[o]=h*d,g[o+1]=s*d,g[o+2]=u*d,g[o+3]=l*d}return g}function DBSCAN(t,r,e){for(var n=new kdTree(t),a={},i=0,o=0;o<t.length;o++)if(null==a[t[o]])if(N=RangeQuery(t,t[o],r,n),N.length<e)a[t[o]]="noise";else{i+=1,a[t[o]]=i;for(var h=N,s=0;s<h.length;s++)"noise"==a[h[s]]&&(a[h[s]]=i),null==a[h[s]]&&(a[h[s]]=i,N=RangeQuery(t,h[s],r,n),N.length>=e&&h.push.apply(h,N))}var u={};for(var l in a)a[l]in u||(u[a[l]]=[]),u[a[l]].push(l.split(","));return u}function RangeQuery(t,r,e,n){return n.rangeSearch(r[0],r[1],e)}function distFunc(t,r){return D=Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2)),D}function kdTree(t){var u=[];function l(t,r,e,n){this.position=t,this.leftChild=r,this.rightChild=e,this.depth=n}!function t(r,e){var n=e%2;var a=r.length;var i=Math.floor((r.length-1)/2);var o=r.length-1;{if(!(0<=i))return;var h=quickSelect(r,0,o,i,n)}var s=new l;s.position=h;1<a&&0<=i&&(s.leftChild=t(r.slice(0,i),e+1),s.rightChild=t(r.slice(i+1,o+1),e+1));s.depth=e;u.push(s);return s}(t,0),this.nodes=u,this.rootNode=u[u.length-1],this.rangeSearch=function(t,r,e){var n=[];return rangeSearch(t,r,e,this.rootNode,n),n}}function quickSelect(t,r,e,n,a){return r==e?t[r]:(pivotIndex=Math.floor(Math.random()*(e-r+1)+r),pivotIndex=partition(t,r,e,pivotIndex,a),n==pivotIndex?t[n]:n<pivotIndex?quickSelect(t,r,pivotIndex-1,n,a):quickSelect(t,pivotIndex+1,e,n,a))}function partition(t,r,e,n,a){pivotVal=t[n][a],swap(t,n,e);for(var i=r,o=r;o<=e-1;o++)t[o][a]<pivotVal&&(swap(t,i,o),i++);return swap(t,e,i),i}function swap(t,r,e){var n=t[r];t[r]=t[e],t[e]=n}function rangeSearch(t,r,e,n,a){var i=e*e;return null==n.leftChild&&null==n.rightChild?void(squareDist(n.position,[t,r])<=i&&a.push(n.position)):intersects(t,r,n,e)?(squareDist(n.position,[t,r])<=i&&a.push(n.position),null!=n.leftChild&&rangeSearch(t,r,e,n.leftChild,a),void(null!=n.rightChild&&rangeSearch(t,r,e,n.rightChild,a))):void(null!=n.leftChild&&1==isLeft(t,r,n)?rangeSearch(t,r,e,n.leftChild,a):rangeSearch(t,r,e,n.rightChild,a))}function getDescendants(t,r){null!=t.leftChild&&(r.push(t.leftChild.position),getDescendants(t.leftChild,r)),null!=t.rightChild&&(r.push(t.rightChild.position),getDescendants(t.rightChild,r))}function intersects(t,r,e,n){var a=n*n,i=e.depth%2;return 0==i&&squareDist([t,r],[e.position[0],r])<=a||1==i&&squareDist([t,r],[t,e.position[1]])<=a}function squareDist(t,r){var e=t[0]-r[0],n=t[1]-r[1];return sD=e*e+n*n,sD}function isLeft(t,r,e){return 0==e.depth%2?t<=e.position[0]:r<=e.position[1]}Fast={THRESHOLD:40,circles_:{},findCorners:function(t,r,e,n){var a=this.getCircleOffsets_(r),i=new Int32Array(16),o=[];void 0===n&&(n=this.THRESHOLD);for(var h=3;h<e-3;h++)for(var s=3;s<r-3;s++){for(var u=h*r+s,l=t[u],c=0;c<16;c++)i[c]=t[u+a[c]];this.isCorner(l,i,n)&&(o.push(s,h),s+=3)}return o},isBrighter:function(t,r,e){return e<t-r},isCorner:function(t,r,e){if(this.isTriviallyExcluded(r,t,e))return!1;for(var n=0;n<16;n++){for(var a=!0,i=!0,o=0;o<9;o++){var h=r[n+o&15];if(!this.isBrighter(t,h,e)&&(i=!1)===a)break;if(!this.isDarker(t,h,e)&&(a=!1)===i)break}if(i||a)return!0}return!1},isDarker:function(t,r,e){return e<r-t},isTriviallyExcluded:function(t,r,e){var n=0,a=t[8],i=t[12],o=t[4],h=t[0];return this.isBrighter(h,r,e)&&n++,this.isBrighter(o,r,e)&&n++,this.isBrighter(a,r,e)&&n++,this.isBrighter(i,r,e)&&n++,n<3&&(n=0,this.isDarker(h,r,e)&&n++,this.isDarker(o,r,e)&&n++,this.isDarker(a,r,e)&&n++,this.isDarker(i,r,e)&&n++,n<3)},getCircleOffsets_:function(t){if(this.circles_[t])return this.circles_[t];var r=new Int32Array(16);return r[0]=-t-t-t,r[1]=r[0]+1,r[2]=r[1]+t+1,r[3]=r[2]+t+1,r[4]=r[3]+t,r[5]=r[4]+t,r[6]=r[5]+t-1,r[7]=r[6]+t-1,r[8]=r[7]-1,r[9]=r[8]-1,r[10]=r[9]-t-1,r[11]=r[10]-t-1,r[12]=r[11]-t,r[13]=r[12]-t,r[14]=r[13]-t+1,r[15]=r[14]-t+1,this.circles_[t]=r}},TImage={grayscale:function(t,r,e,n){for(var a=new Uint8ClampedArray(n?t.length:t.length>>2),i=0,o=0,h=0;h<e;h++)for(var s=0;s<r;s++){var u=.299*t[o]+.587*t[o+1]+.114*t[o+2];a[i++]=u,n&&(a[i++]=u,a[i++]=u,a[i++]=t[o+3]),o+=4}return a}};